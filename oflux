#!/usr/bin/env bash
set -euo pipefail

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVER_BIN="${HERE}/flux_server.py"
CLIENT_BIN="${HERE}/flux_client.py"
SERVER_URL="${FLUX_SERVER:-http://127.0.0.1:8000}"

STATE_FILE="${HERE}/.oflux_installed"
DEFAULT_BIN_DIR="${HOME}/.local/bin"

is_interactive() {
  [[ -t 0 && -t 1 ]]
}

select_requirements_file() {
  local req_file="${HERE}/requirements.txt"
  local rocm_file="${HERE}/requirements_rocm.txt"

  if [[ -n "${OFLUX_REQUIREMENTS:-}" ]]; then
    if [[ -f "${HERE}/${OFLUX_REQUIREMENTS}" ]]; then
      echo "${HERE}/${OFLUX_REQUIREMENTS}"; return 0
    fi
    echo "Requested requirements file ${OFLUX_REQUIREMENTS} not found; falling back to default." >&2
  fi

  if [[ -f "$rocm_file" && -z "${OFLUX_REQUIREMENTS:-}" && is_interactive ]]; then
    read -r -p "Use ROCm requirements (y/N)? " reply
    if [[ "$reply" =~ ^[Yy]$ ]]; then
      req_file="$rocm_file"
    fi
  fi

  echo "$req_file"
}

record_state() {
  local req_file="$1"
  local conda_env_name="$2"
  local symlink_path="$3"
  cat >"$STATE_FILE" <<EOF_STATE
# Auto-generated by oflux self-install
installed_at="$(date -Iseconds)"
requirements_file="$(basename "$req_file")"
conda_env_name="$conda_env_name"
symlink_path="$symlink_path"
EOF_STATE
}

offer_path_hint() {
  local bin_dir="$1"
  if [[ ":${PATH}:" == *":${bin_dir}:"* ]]; then
    return
  fi

  if is_interactive; then
    read -r -p "Add ${bin_dir} to PATH in ~/.bashrc (y/N)? " reply
    if [[ "$reply" =~ ^[Yy]$ ]]; then
      mkdir -p "${HOME}/.bashrc.d" >/dev/null 2>&1 || true
      { echo "# Added by oflux"; echo "export PATH=\"${bin_dir}:\$PATH\""; } >>"${HOME}/.bashrc"
      echo "Appended PATH hint to ~/.bashrc. Restart your shell to pick it up."
    else
      echo "Skipping PATH update. Add 'export PATH=\"${bin_dir}:\$PATH\"' to your shell profile to call 'oflux' globally."
    fi
  else
    echo "Tip: add '${bin_dir}' to your PATH for convenient access (non-interactive shell)."
  fi
}

ensure_symlink() {
  local bin_dir="${OFLUX_BIN_DIR:-$DEFAULT_BIN_DIR}"
  local target="${bin_dir}/oflux"

  if [[ -L "$target" || -x "$target" ]]; then
    echo "$target"
    return
  fi

  if ! is_interactive; then
    echo "Skipping symlink setup in non-interactive mode. Create one manually: ln -sf \"${HERE}/oflux\" \"${target}\"" >&2
    return
  fi

  mkdir -p "$bin_dir"
  read -r -p "Create symlink to oflux in ${bin_dir} (y/N)? " reply
  if [[ "$reply" =~ ^[Yy]$ ]]; then
    ln -sf "${HERE}/oflux" "$target"
    echo "Created symlink: $target"
    offer_path_hint "$bin_dir"
    echo "$target"
  fi
}

install_dependencies() {
  local req_file
  req_file="$(select_requirements_file)"
  echo "Installing Python dependencies from ${req_file}..."
  python -m pip install --upgrade pip
  python -m pip install -r "$req_file"
  echo "$req_file"
}

read_state_file() {
  [[ -f "$STATE_FILE" ]] || return
  # shellcheck disable=SC1090
  source "$STATE_FILE"
}

activate_saved_conda_env() {
  local saved_env="$1"
  [[ -n "$saved_env" ]] || return

  local current_env="${CONDA_DEFAULT_ENV:-}"
  if [[ "$current_env" == "$saved_env" ]]; then
    return
  fi

  if ! command -v conda >/dev/null 2>&1; then
    echo "conda not found; cannot activate stored environment '$saved_env'." >&2
    return
  fi

  # shellcheck disable=SC1091
  eval "$(conda shell.bash hook)" >/dev/null 2>&1 || { echo "Failed to load conda shell integration." >&2; return; }

  if conda env list | awk '{print $1}' | grep -qx "$saved_env"; then
    echo "Switching conda environment to '$saved_env'."
    conda activate "$saved_env"
  else
    echo "Stored conda environment '$saved_env' is unavailable; continuing with current environment." >&2
  fi
}

ensure_installed() {
  local initial_conda_env="${CONDA_DEFAULT_ENV:-}"
  local req_file=""
  local symlink_path=""

  if [[ ! -f "$STATE_FILE" ]]; then
    echo "oflux dependencies not detected; starting guided setup."
    req_file="$(install_dependencies)"
    symlink_path="$(ensure_symlink || true)"
    record_state "$req_file" "$initial_conda_env" "$symlink_path"
  else
    read_state_file
  fi

  activate_saved_conda_env "${conda_env_name:-}"
}

ensure_installed

usage() {
  cat <<'EOF_USAGE'
flux - tiny model manager

USAGE
  oflux serve [--host HOST] [--port PORT] [--config PATH] [--models PATH]
  oflux ls
  oflux defaults
  oflux set-defaults <model-id> [options]
  oflux unload
  oflux load <model-id>
  oflux pull <model-id>
  oflux rm <model-id>
  oflux run "prompt text ..." [options]
  oflux -h

RUN OPTIONS
  -m, --model MODEL         Model repo id to use (will be added on success)
  -s, --steps N             Inference steps (e.g. 4–12 for previews)
  -W, --width PX            Image width (default 512)
  -H, --height PX           Image height (default 512)
  -g, --guidance G          Guidance scale (default 3.5)
  -n, --num-images K        Number of images (default 1)
  -S, --seed N              Seed for reproducibility
  -o, --outfile PATH        Output file or prefix (if -n>1)
  -O, --outdir DIR          Directory to save images (client side, default .)
  -p, --preview             Preview inline (Kitty terminal only)
  -q, --quantize MODE       Quantization override (auto, none, bnb4, bnb8)

TIPS
  - Start small (512x512, 4–8 steps) then scale up.
  - Edit config.json to tweak unload_timeout, memory_fraction, defaults.
  - Server auto-unloads models after inactivity.

EXAMPLES
  flux serve --host 127.0.0.1 --port 8000
  flux ls
  flux run "A neon samurai in the rain" -s 6 -p
EOF_USAGE
}

cmd="${1:-}"; shift || true

case "${cmd}" in
  serve)
    host="127.0.0.1"; port="8000"; config="${HERE}/config.json"; models="${HERE}/models.json"
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --host) host="$2"; shift 2 ;;
        --port) port="$2"; shift 2 ;;
        --config) config="$2"; shift 2 ;;
        --models) models="$2"; shift 2 ;;
        *) echo "Unknown arg: $1"; usage; exit 1 ;;
      esac
    done
    # Hint: you may export this before serving to keep desktop smooth on ROCm
    # export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True,max_split_size_mb:64"
    exec python "$SERVER_BIN" --host "$host" --port "$port" --config "$config" --models "$models"
    ;;

  ls)         python "$CLIENT_BIN" --server "$SERVER_URL" ls ;;
  defaults)   python "$CLIENT_BIN" --server "$SERVER_URL" defaults ;;
  set-defaults) python "$CLIENT_BIN" --server "$SERVER_URL" set-defaults "$@" ;;
  unload)     python "$CLIENT_BIN" --server "$SERVER_URL" unload ;;
  load)       python "$CLIENT_BIN" --server "$SERVER_URL" load "$@" ;;
  pull)       python "$CLIENT_BIN" --server "$SERVER_URL" pull "$@" ;;
  rm)         python "$CLIENT_BIN" --server "$SERVER_URL" rm "$@" ;;
  run)        python "$CLIENT_BIN" --server "$SERVER_URL" run "$@" ;;
  -h|--help|help|"") usage ;;
  *) echo "Unknown command: $cmd"; usage; exit 1 ;;
esac
